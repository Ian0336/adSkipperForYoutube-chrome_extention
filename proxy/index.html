<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouTube Embed Proxy</title>
    <style>
      html, body { height: 100%; }
      * { box-sizing: border-box; }
      body { margin: 0; background: #000; }
      #playerWrapper, iframe { width: 100%; height: 100%; border: 0; display: block; }
      #message {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: #ffffff;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      #message code { display: inline-block; background: #111; padding: 4px 8px; border-radius: 6px; }
      a { color: #4ea1ff; }
    </style>
  </head>
  <body>
    <div id="playerWrapper" style="display:none;">
      <iframe
        id="player"
        title="YouTube video player"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
        referrerpolicy="origin-when-cross-origin"
        src=""
      ></iframe>
    </div>

    <div id="message">
      <div>
        <h1 style="margin: 0 0 12px; font-size: 18px; font-weight: 600;">YouTube Embed Proxy</h1>
        <p style="margin: 0 0 8px; opacity: 0.85;">
          Provide a YouTube video ID in the path or query.
        </p>
        <p style="margin: 0 0 16px;">
          <code>/{videoId}</code> or <code>?v={videoId}</code>
        </p>
      </div>
    </div>

    <script>
      (function () {
        function getParam(name, search) {
          var params = new URLSearchParams(search || "");
          var value = params.get(name);
          return value && value.trim() ? value.trim() : null;
        }

        function looksLikeVideoId(str) {
          // Basic heuristic for YouTube video IDs
          return /^[A-Za-z0-9_-]{6,}$/.test(str) && str.toLowerCase() !== "index.html";
        }

        function extractVideoId(loc) {
          // Priority: query `v` -> query `videoId` -> last non-empty path segment
          var byV = getParam("v", loc.search);
          if (byV) return byV;

          var byVideoId = getParam("videoId", loc.search);
          if (byVideoId) return byVideoId;

          var segments = (loc.pathname || "").split("/").filter(Boolean);
          if (segments.length) {
            var candidate = segments[segments.length - 1];
            if (looksLikeVideoId(candidate)) return candidate;
          }
          return null;
        }

        var videoId = extractVideoId(window.location);
        if (!videoId) {
          document.title = "YouTube Embed Proxy";
          return;
        }

        var base = "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(videoId);
        var params = [
          "autoplay=1",
          "playsinline=1",
          "rel=0",
          "modestbranding=1",
          "enablejsapi=1",
        ];

        // Pass through optional start time if present (supports `start` or `t` in seconds)
        var start = getParam("start", window.location.search) || getParam("t", window.location.search);
        if (start && /^\d+$/.test(start)) params.push("start=" + start);

        var src = base + "?" + params.join("&");
        var iframe = document.getElementById("player");
        iframe.src = src;

        document.title = "\u25B6 " + videoId + " - YouTube Embed";
        var messageEl = document.getElementById("message");
        var wrapperEl = document.getElementById("playerWrapper");
        if (messageEl) messageEl.style.display = "none";
        if (wrapperEl) wrapperEl.style.display = "block";

        // Listen for commands from parent (e.g., extension content script)
        window.addEventListener("message", function (event) {
          var data = event.data;
          if (typeof data === "string") {
            try { data = JSON.parse(data); } catch (_) { /* ignore */ }
          }

          if (!data || typeof data !== "object") return;

          if (data.type === "setPlaybackRate" && iframe && iframe.contentWindow) {
            var rate = Number(data.value);
            if (!Number.isFinite(rate) || rate <= 0) rate = 1;
            // Forward to YouTube player via postMessage API
            try {
              iframe.contentWindow.postMessage(
                JSON.stringify({ event: "command", func: "setPlaybackRate", args: [rate] }),
                "*"
              );
            } catch (_) { /* ignore */ }
          }
        });
      })();
    </script>
  </body>
</html>
