<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouTube Embed Proxy</title>
    <style>
      html, body { height: 100%; }
      * { box-sizing: border-box; }
      body { margin: 0; background: #000; }
      #playerWrapper, iframe { width: 100%; height: 100%; border: 0; display: block; }
      #message {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: #ffffff;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      #message code { display: inline-block; background: #111; padding: 4px 8px; border-radius: 6px; }
      a { color: #4ea1ff; }
    </style>
  </head>
  <body>
    <div id="playerWrapper" style="display:none;">
      <div id="player"></div>
    </div>

    <div id="message">
      <div>
        <h1 style="margin: 0 0 12px; font-size: 18px; font-weight: 600;">YouTube Embed Proxy</h1>
        <p style="margin: 0 0 8px; opacity: 0.85;">
          Provide a YouTube video ID in the path or query.
        </p>
        <p style="margin: 0 0 16px;">
          <code>/{videoId}</code> or <code>?v={videoId}</code>
        </p>
      </div>
    </div>

    <script>
      (function () {
        function getParam(name, search) {
          var params = new URLSearchParams(search || "");
          var value = params.get(name);
          return value && value.trim() ? value.trim() : null;
        }

        function looksLikeVideoId(str) {
          return /^[A-Za-z0-9_-]{6,}$/.test(str) && str.toLowerCase() !== "index.html";
        }

        function extractVideoId(loc) {
          var byV = getParam("v", loc.search);
          if (byV) return byV;
          var byVideoId = getParam("videoId", loc.search);
          if (byVideoId) return byVideoId;
          var segments = (loc.pathname || "").split("/").filter(Boolean);
          if (segments.length) {
            var candidate = segments[segments.length - 1];
            if (looksLikeVideoId(candidate)) return candidate;
          }
          return null;
        }

        var videoId = extractVideoId(window.location);
        if (!videoId) {
          document.title = "YouTube Embed Proxy";
          return;
        }

        document.title = "\u25B6 " + videoId + " - YouTube Embed";
        var messageEl = document.getElementById("message");
        var wrapperEl = document.getElementById("playerWrapper");
        if (messageEl) messageEl.style.display = "none";
        if (wrapperEl) wrapperEl.style.display = "block";

        var start = getParam("start", window.location.search) || getParam("t", window.location.search);
        var startSec = start && /^\d+$/.test(start) ? Number(start) : null;

        var player = null;
        var pendingRate = null;
        var lastRequestedRate = null; // remember last rate to re-apply after reloads

        // Progress tracking per videoId (in-memory only)
        var progressByVideoId = Object.create(null);
        var progressIntervalId = null;
        var lastAdReloadAt = 0;
        var adReloadCooldownMs = 5000; // avoid rapid reload loops

        var lastCurrentTime = 0;
        var lastPlayerState = 0;
        var detectionTimeInterval = 500;

        function resetProgressFor(id) {
          progressByVideoId[id] = { currentTime: 0, updatedAt: Date.now() };
        }

        function saveProgress(id, seconds) {
          var sec = Number(seconds);
          if (!Number.isFinite(sec) || sec < 0) sec = 0;
          progressByVideoId[id] = { currentTime: sec, updatedAt: Date.now() };
        }

        function readProgress(id) {
          var obj = progressByVideoId[id];
          var t = Number(obj && obj.currentTime);
          return Number.isFinite(t) && t >= 0 ? t : 0;
        }

        function safeSetRate(rate) {
          var r = Number(rate);
          if (!Number.isFinite(r) || r <= 0) r = 1;
          try {
            if (player && typeof player.setPlaybackRate === "function") {
              player.setPlaybackRate(r);
            } else {
              pendingRate = r;
            }
          } catch (_) {
            pendingRate = r;
          }
        }

        // Load YouTube Iframe API
        // Reset progress when a new video id is loaded
        resetProgressFor(videoId);

        var tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName("script")[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function () {
          var playerVars = {
            autoplay: 1,
            playsinline: 1,
            rel: 0,
            modestbranding: 1
          };
          if (startSec != null) playerVars.start = startSec;

          player = new YT.Player("player", {
            host: "https://www.youtube-nocookie.com",
            width: "100%",
            height: "100%",
            videoId: videoId,
            playerVars: playerVars,
            events: {
              onReady: function () {
                try { player.playVideo(); } catch (_) {}
                if (pendingRate != null) {
                  safeSetRate(pendingRate);
                  pendingRate = null;
                }

                // Start 500ms interval to persist progress
                try { if (progressIntervalId) clearInterval(progressIntervalId); } catch (_) {}
                progressIntervalId = setInterval(function () {
                  try {
                    if (player && typeof player.getCurrentTime === "function") {
                      var t = player.getCurrentTime();
                      var s = player.getPlayerState();
                      console.log("getPlayerState", s, t);
                      var state = typeof player.getPlayerState === "function" ? player.getPlayerState() : null; // 1 = playing
                      // console.log("getCurrentTime", t);
                      // console.log("getDuration", d);

                      // Heuristic: if total duration is very short, likely an ad
                      if ((lastPlayerState === 1 && s === 1 && (t - lastCurrentTime) < detectionTimeInterval*0.8*0.001) || s === -1) {
                        console.log("Playing ad");
                        var now = Date.now();
                        if (now - lastAdReloadAt > adReloadCooldownMs) {
                          lastAdReloadAt = now;
                          // Reload the video to last saved progress
                          var resumeAt = readProgress(videoId);
                          try {
                            player.loadVideoById({ videoId: videoId, startSeconds: resumeAt });
                            // Re-apply last requested rate shortly after reload
                            if (lastRequestedRate != null) {
                              setTimeout(function () {
                                try { player.setPlaybackRate(lastRequestedRate); } catch (_) {}
                              }, 500);
                            }
                          } catch (_) { /* ignore */ }
                        }
                      }

                      lastCurrentTime = t;
                      lastPlayerState = s;

                      if (Number.isFinite(t)) saveProgress(videoId, t);
                    }
                  } catch (_) { /* ignore */ }
                }, detectionTimeInterval);

              }
            }
          });
        };

        // Listen for commands from parent (e.g., extension content script)
        window.addEventListener("message", function (event) {
          var data = event.data;
          if (typeof data === "string") {
            try { data = JSON.parse(data); } catch (_) { /* ignore */ }
          }
          if (!data || typeof data !== "object") return;
          if (data.type === "setPlaybackRate") {
            lastRequestedRate = Number(data.value);
            safeSetRate(data.value);
          }
        });

        // Ensure we stop the interval and persist one last time on unload
        window.addEventListener("beforeunload", function () {
          try {
            if (player && typeof player.getCurrentTime === "function") {
              var t = player.getCurrentTime();
              if (Number.isFinite(t)) saveProgress(videoId, t);
            }
          } catch (_) { /* ignore */ }
          try { if (progressIntervalId) clearInterval(progressIntervalId); } catch (_) {}
        });
      })();
    </script>
  </body>
</html>
