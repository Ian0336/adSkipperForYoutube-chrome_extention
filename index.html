<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouTube Embed Proxy</title>
    <style>
      html, body { height: 100%; }
      * { box-sizing: border-box; }
      body { margin: 0; background: #000; }
      #playerWrapper, iframe { width: 100%; height: 100%; border: 0; display: block; }
      #message {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: #ffffff;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      #message code { display: inline-block; background: #111; padding: 4px 8px; border-radius: 6px; }
      a { color: #4ea1ff; }
    </style>
  </head>
  <body>
    <div id="playerWrapper" style="display:none;">
      <div id="player"></div>
    </div>

    <div id="message">
      <div>
        <h1 style="margin: 0 0 12px; font-size: 18px; font-weight: 600;">YouTube Embed Proxy</h1>
        <p style="margin: 0 0 8px; opacity: 0.85;">
          Provide a YouTube video ID in the path or query.
        </p>
        <p style="margin: 0 0 16px;">
          <code>/{videoId}</code> or <code>?v={videoId}</code>
        </p>
      </div>
    </div>

    <script>
      (function () {
        function getParam(name, search) {
          var params = new URLSearchParams(search || "");
          var value = params.get(name);
          return value && value.trim() ? value.trim() : null;
        }

        function looksLikeVideoId(str) {
          return /^[A-Za-z0-9_-]{6,}$/.test(str) && str.toLowerCase() !== "index.html";
        }

        function extractVideoId(loc) {
          var byV = getParam("v", loc.search);
          if (byV) return byV;
          var byVideoId = getParam("videoId", loc.search);
          if (byVideoId) return byVideoId;
          var segments = (loc.pathname || "").split("/").filter(Boolean);
          if (segments.length) {
            var candidate = segments[segments.length - 1];
            if (looksLikeVideoId(candidate)) return candidate;
          }
          return null;
        }
        function extractListId(loc) {
          var byList = getParam("list", loc.search);
          if (byList) return byList;
          return null;
        }

        var videoId = extractVideoId(window.location);
        var listId = extractListId(window.location);
        console.log(window.location);
        if (!videoId) {
          document.title = "YouTube Embed Proxy";
          return;
        }

        document.title = "\u25B6 " + videoId + " - YouTube Embed";
        var messageEl = document.getElementById("message");
        var wrapperEl = document.getElementById("playerWrapper");
        if (messageEl) messageEl.style.display = "none";
        if (wrapperEl) wrapperEl.style.display = "block";

        var start = getParam("start", window.location.search) || getParam("t", window.location.search);
        var startSec = start && /^\d+$/.test(start) ? Number(start) : null;

        var player = null;
        var pendingRate = null;
        var lastRequestedRate = null; // remember last rate to re-apply after reloads

        // Progress tracking per videoId (in-memory only)
        var progressByVideoId = Object.create(null);
        var progressIntervalId = null;
        var lastAdReloadAt = 0;
        var adReloadCooldownMs = 1000; // avoid rapid reload loops

        var lastTime = 0;
        
        // Background video player for ads
        var backgroundPlayer = null;
        var backgroundPlayerReady = false;
        var isPlayingAdInBackground = false;

        var detectionTimeInterval = 500;

        function resetProgressFor(id) {
          progressByVideoId[id] = { currentTime: 0, updatedAt: Date.now() };
        }

        function saveProgress(id, seconds) {
          var sec = Number(seconds);
          if (!Number.isFinite(sec) || sec < 0) sec = 0;
          progressByVideoId[id] = { currentTime: sec, updatedAt: Date.now() };
        }

        function readProgress(id) {
          var obj = progressByVideoId[id];
          var t = Number(obj && obj.currentTime);
          return Number.isFinite(t) && t >= 0 ? t : 0;
        }

        function safeSetRate(rate) {
          var r = Number(rate);
          if (!Number.isFinite(r) || r <= 0) r = 1;
          try {
            if (player && typeof player.setPlaybackRate === "function") {
              player.setPlaybackRate(r);
            } else {
              pendingRate = r;
            }
          } catch (_) {
            pendingRate = r;
          }
        }

        function createBackgroundPlayer() {
          // Create hidden container for background player
          var bgContainer = document.createElement("div");
          bgContainer.id = "backgroundPlayer";
          bgContainer.style.cssText = "position: absolute; top: 0px; left: 0px; width: 100px; height: 100px; opacity: 0.5; pointer-events: none;";
          document.body.appendChild(bgContainer);

          // Initialize background player with YouTube API
          backgroundPlayer = new YT.Player("backgroundPlayer", {
            width: "1",
            height: "1",
            videoId: "dQw4w9WgXcQ", // Default video (Rick Roll as placeholder)
            playerVars: {
              autoplay: 0,
              controls: 0,
              disablekb: 1,
              fs: 0,
              modestbranding: 1,
              rel: 0,
              showinfo: 0,
              mute: 1, // Mute the background player
              playsinline: 1
            },
            events: {
              onReady: function() {
                backgroundPlayerReady = true;
                console.log("Background player ready");
              },
              onStateChange: function(event) {
                // Monitor background player state
                if (event.data === YT.PlayerState.ENDED && isPlayingAdInBackground) {
                  console.log("Background ad finished playing");
                  isPlayingAdInBackground = false;
                }
              }
            }
          });
        }

        function playAdInBackground(adVideoId) {
          if (!backgroundPlayerReady || isPlayingAdInBackground) return;
          
          try {
            console.log("Playing ad in background for 10 seconds:", adVideoId);
            isPlayingAdInBackground = true;
            
            // Load and play the ad video in background
            backgroundPlayer.loadVideoById({
              videoId: adVideoId || "dQw4w9WgXcQ", // Fallback video
              startSeconds: 0
            });
            
            // Ensure it's muted and hidden
            setTimeout(function() {
              try {
                backgroundPlayer.mute();
                backgroundPlayer.playVideo();
              } catch(e) {
                console.log("Error controlling background player:", e);
              }
            }, 500);
            
            // Stop background ad after 10 seconds
            setTimeout(function() {
              try {
                console.log("Stopping background ad after 10 seconds");
                backgroundPlayer.pauseVideo();
                backgroundPlayer.stopVideo();
                isPlayingAdInBackground = false;
              } catch(e) {
                console.log("Error stopping background player:", e);
                isPlayingAdInBackground = false;
              }
            }, 10000); // 10 seconds = 10000 milliseconds
            
          } catch(e) {
            console.log("Error playing ad in background:", e);
            isPlayingAdInBackground = false;
          }
        }
        // Load YouTube Iframe API
        // Reset progress when a new video id is loaded
        resetProgressFor(videoId);

        var tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName("script")[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function () {
          var playerVars = {
            autoplay: 1,
            playsinline: 1,
            rel: 0,
          };
          if (listId) {
            playerVars.listType = "playlist";
            playerVars.list = listId;
          }
          if (startSec != null) playerVars.start = startSec;
          console.log(playerVars);
          player = new YT.Player("player", {
            // host: "https://www.youtube-nocookie.com",
            width: "100%",
            height: "100%",
            videoId: videoId,
            playerVars: playerVars,
            events: {
              onReady: function () {
                try { player.playVideo(); } catch (_) {}
                if (pendingRate != null) {
                  safeSetRate(pendingRate);
                  pendingRate = null;
                }

                createBackgroundPlayer();

                // Start 500ms interval to persist progress
                try { if (progressIntervalId) clearInterval(progressIntervalId); } catch (_) {}
                progressIntervalId = setInterval(function () {
                  try {
                    if (player && typeof player.getCurrentTime === "function") {
                      var t = player.getCurrentTime();
                      var s = player.getPlayerState();
                      var d = player.getDuration();
                      var data = player.getVideoData();
                      var state = typeof player.getPlayerState === "function" ? player.getPlayerState() : null; // 1 = playing
                      // console.log("getVideoData", player.getVideoData());
                      // console.log("getDuration", d);
                      // Heuristic: if total duration is very short, likely an ad
                      if ((s === -1 && !(t == lastTime)  || data?.author == "")) {
                        console.log("Ad detected", data);
                        var now = Date.now();
                        if (now - lastAdReloadAt > adReloadCooldownMs) {
                          lastAdReloadAt = now;
                          
                          // Start playing an ad in background to simulate ad viewing
                          playAdInBackground(videoId);
                          
                          // Reload the video to last saved progress
                          var resumeAt = readProgress(videoId);
                          console.log("Ad detected - playing ad in background and reloading main video", videoId, resumeAt);
                          try {
                            if (listId) {
                              player.loadPlaylist({ playlistId: listId, startIndex: resumeAt });
                            } else {
                              player.loadVideoById({ videoId: videoId, startSeconds: resumeAt });
                            }
                            // Re-apply last requested rate shortly after reload
                            if (lastRequestedRate != null) {
                              setTimeout(function () {
                                try { player.setPlaybackRate(lastRequestedRate); } catch (_) {}
                              }, 500);
                            }
                          } catch (_) { /* ignore */ }
                        }
                      } else {

                        if (Number.isFinite(t)) saveProgress(videoId, t);
                      }
                      lastTime = t;
                    }
                  } catch (_) { /* ignore */ }
                }, detectionTimeInterval);

              }
            }
          });
        };

        // Listen for commands from parent (e.g., extension content script)
        window.addEventListener("message", function (event) {
          var data = event.data;
          if (typeof data === "string") {
            try { data = JSON.parse(data); } catch (_) { /* ignore */ }
          }
          if (!data || typeof data !== "object") return;
          if (data.type === "setPlaybackRate") {
            lastRequestedRate = Number(data.value);
            safeSetRate(data.value);
          }
        });

        // Ensure we stop the interval and persist one last time on unload
        window.addEventListener("beforeunload", function () {
          try {
            if (player && typeof player.getCurrentTime === "function") {
              var t = player.getCurrentTime();
              if (Number.isFinite(t)) saveProgress(videoId, t);
            }
          } catch (_) { /* ignore */ }
          try { if (progressIntervalId) clearInterval(progressIntervalId); } catch (_) {}
        });
      })();
    </script>
  </body>
</html>
